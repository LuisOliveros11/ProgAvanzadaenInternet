<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles</title>
    <link rel="stylesheet" href="estilo.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="" id="home">
        <div class="titulo">
            <h1>
                Detalles de película
            </h1>
        </div>

        <div class="contenedor" :style="{ backgroundImage: 'url(' + img_Fondo + ')' }">
            <div class="imagen">
                <img v-bind:src="'https://media.themoviedb.org/t/p/w440_and_h660_face/' + detalles_general.poster_path" alt="">
            </div>
            <div class="texto">
                <h1>
                    {{detalles_general.original_title}} 
                </h1>
                <h5>
                    {{detalles_general.release_date}} ({{detalles_general.original_language}}) ● {{generos.join(', ')}} ● {{obtenerDuracion(detalles_general.runtime)}}
                </h5>
                <h3 id="porcentaje">
                    {{obtenerPorcentajeVotos(detalles_general.vote_average)}}% Puntuación de usuarios
                </h3>
                <h3 id="rate">
                    Haz tu rate!
                </h3>
                <input type="number" v-model="calif" max="10" min="0.5" step="0.5" id="inputNumber" class="form-control" aria-describedby="numberHelp" placeholder="0.5">
                <button type="button" class="btn btn-success" @click="enviarRate()">Enviar</button>
                <h5 id="tagline">
                    {{detalles_general.tagline}}
                </h5>
                <h4>
                    Vista general
                </h4>
                <h5 id="descripcion">            
                    {{detalles_general.overview}}
                </h5>
                <div class="casting" v-for="trabajador in cast">
                    <h5 id="nombre_trabajador">
                        {{trabajador.name}}
                    </h5>
                    <h5>
                        {{trabajador.job}}
                    </h5>
                </div>
            </div>
        </div>
       
    </div>
</body>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const { createApp, ref } = Vue
createApp({
    setup() {
        let detalles_general = ref({});
        let detalles_creditos = ref({});
        let generos = ref([]);
        let cast = ref([]);
        let img_Fondo = ref("");
        let calif = ("");
    
    return {
        detalles_general,
        detalles_creditos,
        cast,
        generos,
        img_Fondo,
        calif
    }
    },
    methods: {
        obtenerDuracion(tiempo){
        const horas = Math.floor(tiempo / 60); 
        const minutosRestantes = tiempo % 60; 
        return `${horas} hora(s) y ${minutosRestantes} minuto(s)`;
    },
        obtenerPorcentajeVotos(votacion){
            const porcentaje = votacion * 10; 
            return porcentaje;
    },
        enviarRate(){
            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            const raw = JSON.stringify({
                "value": this.calif
            });

            const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
            };

            fetch("https://api.themoviedb.org/3/movie/" + localStorage.getItem("pelicula_Detalles") + "/rating?api_key=9cf1198f36410ea23852c01c0c427731&session_id=e4a0f7e6b9797224ccb081defcea9badd9dcc42b", requestOptions)
            .then((response) => response.json())
            .then((result) => {
                if(result.success){
                    console.log(result)
                    alert("Calificación enviada correctamente. Gracias")
                }else{
                    alert("Error al enviar la calificación")
                }
            })
            .catch((error) => console.error(error));
    }
},
mounted() { 
		let logeado = localStorage.getItem("logeado");
		let usuario = localStorage.getItem("usuario");
        let pelicula_Detalles = localStorage.getItem("pelicula_Detalles");
        let request_token = localStorage.getItem("request_token");

		if (logeado == null && usuario == null) { 
		    window.location.href = "index.html";
		}

            var requestOptions = {
            method: 'GET',
            redirect: 'follow'
            };

            fetch("https://api.themoviedb.org/3/movie/" + localStorage.getItem("pelicula_Detalles") + "?&api_key=9cf1198f36410ea23852c01c0c427731", requestOptions)
            .then(response => response.json())
            .then(result =>{
                this.detalles_general = result;
                
                this.detalles_general.genres.forEach(genero => {
                this.generos.push(genero.name);

                this.img_Fondo = "https://media.themoviedb.org/t/p/w440_and_h660_face/" + this.detalles_general.backdrop_path;
            });
            })
            .catch(error => console.log('error', error));

            var requestOptions = {
            method: 'GET',
            redirect: 'follow'
            };

            fetch("https://api.themoviedb.org/3/movie/" + localStorage.getItem("pelicula_Detalles") + "/credits?api_key=9cf1198f36410ea23852c01c0c427731", requestOptions)
            .then(response => response.json())
            .then(result =>{
                this.detalles_creditos = result.crew

                for (let index = 0; index < 6; index++) {
                    this.cast.push(this.detalles_creditos[index])
                }
            })
            .catch(error => console.log('error', error));
            
    }
}).mount('#home')
</script>
</html>